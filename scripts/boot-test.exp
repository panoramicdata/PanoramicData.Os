#!/usr/bin/expect -f
# Automated boot test for CI
# Checks that the system boots and displays expected messages

set timeout 60
set kernel [lindex $argv 0]
set initrd [lindex $argv 1]

if {$kernel eq ""} {
    set kernel "output/vmlinuz"
}
if {$initrd eq ""} {
    set initrd "output/initramfs.cpio.gz"
}

spawn qemu-system-x86_64 \
    -kernel $kernel \
    -initrd $initrd \
    -append "console=ttyS0,115200n8 panic=1" \
    -m 512M \
    -smp 2 \
    -nographic \
    -serial mon:stdio \
    -no-reboot

# Wait for kernel to boot
expect {
    timeout {
        puts "\n\n=== TIMEOUT: Kernel did not boot ==="
        exit 1
    }
    "Kernel panic" {
        puts "\n\n=== FAILED: Kernel panic ==="
        exit 1
    }
    "Run /init as init process" {
        puts "\n=== Kernel starting init process ==="
    }
}

# Wait for .NET init message
expect {
    timeout {
        puts "\n\n=== TIMEOUT: Init did not start ==="
        exit 1
    }
    "Hello from .NET" {
        puts "\n=== SUCCESS: .NET init started ==="
    }
}

# Wait for filesystems to be mounted
expect {
    timeout {
        puts "\n\n=== TIMEOUT: Filesystems not mounted ==="
        exit 1
    }
    "Init complete. System ready." {
        puts "\n=== SUCCESS: System ready ==="
    }
}

# Wait for shell prompt
expect {
    timeout {
        puts "\n\n=== TIMEOUT: Shell did not start ==="
        exit 1
    }
    "root@panos" {
        puts "\n=== SUCCESS: Shell started ==="
    }
}

# Give it a moment
sleep 1

# Test 'help' command
send "help\r"
expect {
    timeout {
        puts "\n\n=== TIMEOUT: help command failed ==="
        exit 1
    }
    "Available commands" {
        puts "\n=== SUCCESS: help command works ==="
    }
}

# Test 'pwd' command
send "pwd\r"
expect {
    timeout {
        puts "\n\n=== TIMEOUT: pwd command failed ==="
        exit 1
    }
    "/" {
        puts "\n=== SUCCESS: pwd command works ==="
    }
}

# Test 'ls' command
send "ls\r"
expect {
    timeout {
        puts "\n\n=== TIMEOUT: ls command failed ==="
        exit 1
    }
    "bin" {
        puts "\n=== SUCCESS: ls command works ==="
    }
}

# Test 'uname -a' command
send "uname -a\r"
expect {
    timeout {
        puts "\n\n=== TIMEOUT: uname command failed ==="
        exit 1
    }
    "panos" {
        puts "\n=== SUCCESS: uname command works ==="
    }
}

# Give it a moment
sleep 1

# Send shutdown signal (Ctrl+A, X to quit QEMU)
send "\x01"
send "x"

puts "\n\n=== BOOT AND SHELL TEST PASSED ==="
exit 0
